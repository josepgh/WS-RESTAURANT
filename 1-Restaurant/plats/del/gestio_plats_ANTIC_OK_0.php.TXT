<?php
session_start();

require("../includes/header.php");
require("../functions/funcions.php");

// Conexió a la base de datos
// $conn = new mysqli("localhost", "root", "mdb", "restaurantdb");
// if ($conn->connect_error) {
//     die("❌ Error de connexió: " . $conn->connect_error);
// }

// ===============================================================
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['id_c'])) {
        $_SESSION['id_cat_opcio'] = $_POST['id_c'];
    }
    if (isset($_POST['nom_c'])) {
        $_SESSION['nom_cat_opcio'] = $_POST['nom_c'];
    }
//     echo "Categoría guardada en sesión.";
}
// Recuperar categoria seleccionada
$id_cat_opcio = $_SESSION['id_cat_opcio'] ?? '';
// Recuperar categoria seleccionada (antic)
$nom_cat_opcio = $_SESSION['nom_cat_opcio'] ?? '';
// ==================================================================
?>

<!DOCTYPE html>

<html>
<head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>    
    <link rel="stylesheet" type="text/css" href="../css/estils.css">
    <title>Gestio plats</title>
</head>
<body>

<table>
<tr>
<td>
	<br>
	<label for="ca">Selecciona una categoria</laber>
    <select id="ca" name="categoria" onchange="guardarCatEnSessio(this)">
        <option value="">-- Selecciona categoria --</option>
    <?php
        $conn = getConnexio();
        $stmt = $conn->prepare("SELECT id_categoria, nom FROM categories ORDER BY id_categoria");
        $stmt->execute();
        $categs = $stmt->get_result();
        
       while ($cat_row = $categs->fetch_assoc()) {
                
                echo "<option value='" . $cat_row['id_categoria'] . "' " .    ($cat_row['id_categoria'] == $id_cat_opcio ? 'selected' : '') .     ">" . $cat_row['nom'] . "</option>";
        }
        $stmt->close();
        mysqli_close($conn);
    ?>
    </select>
    <h4>Categoria seleccionada: <?= htmlspecialchars($nom_cat_opcio ?: 'Ninguna') ?></h4>

</td>
</tr>
</table>

<table>
	<thead>
	<tr>
			<th>Id</th><th>Nom</th><th>Descripcio</th><th>Preu</th><th>Id categoria</th><th>Edita</th><th>Esborra</th>
	</tr>
	</thead>
<tbody>
 
<?php     
    //if ($result->num_rows > 0) {
    if ($id_cat_opcio !== '') { // si no es buit
            
        //         $_SESSION['id_categ'] = $_REQUEST['id_categoria'];
        $conn = getConnexio();
        
        //     $categoria_id = intval($_POST["id_categoria"]);
        
        //$sql = "SELECT id_plat, nom, descripcio, preu, id_categoria FROM plats WHERE id_categoria = $id_cat_opcio ORDER BY nom";
        $stmt = $conn->prepare("SELECT id_plat, nom, descripcio, preu, id_categoria FROM plats WHERE id_categoria = ? ORDER BY nom");
        $stmt->bind_param("i", $id_cat_opcio);
        $stmt->execute();
        $plats = $stmt->get_result();
        
        //$result = $conn->query($sql);
        
        
//         echo "<table> <thead> <tr>";
//         echo "<th>Id</th> <th>Nom</th> <th>Descripcio</th> <th>Preu</th> <th>ID categoria</th><th>Edita</th><th>Esborra</th>";
//         echo "</tr> </thead> <tbody>";
        
        while ($plats_row = $plats->fetch_assoc()) {
            //             echo "<table>";
            echo "<tr>";
            echo "<td>" . $plats_row['id_plat'] . "</td>";
            echo "<td>" . $plats_row['nom'] . "</td>";
            echo "<td>" . $plats_row['descripcio'] . "</td>";
            echo "<td>" . $plats_row['preu'] . "</td>";
            echo "<td>" . $plats_row['id_categoria'] . "</td>";
    
            echo "<td><div><a href='plat_to_update.php?id_plat=" . $plats_row['id_plat'] . "' class='btn btn-info' role='button'>Edita</a></div></td>";
            echo "<td><div><a href='plat_to_delete.php?id_plat=" . $plats_row['id_plat'] . "' class='btn btn-danger disabled' role='button' aria-disabled='true'>Esborra</a></div></td>";
            
            echo "</tr>";
        }
//         echo "</tbody>";
//         echo "</table>";
        $stmt->close();
        mysqli_close($conn);
        
    } elseif ($id_cat_opcio) {
        echo "<table><tr><td colspan='7'>No hi plats d'aquesta categoria.</td></tr></table>";
    } else {
        echo "<table><tr><td colspan='7'><h3>Selecciona una categoria per veure els plats disponibles.</h3></td></tr></table>";
    }    
    ?>

</tbody>
</table>

    <div id="resultat" 
    	style="margin-top: 15px; font-weight: bold;">
	</div>

        <script>
        function guardarCatEnSessio(categoria) {
            
            const id_c = categoria.value;
            const nom_c = categoria.options[categoria.selectedIndex].text;

            const dades = new URLSearchParams();
            dades.append('id_c', id_c);
            dades.append('nom_c', nom_c);
	
            fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
//                 body: 'id_categoria_selecc=' + encodeURIComponent(id_c)
                body: dades.toString()
            })
            .then(response => response.text())
             .then(data => {
//                 document.getElementById("resultat").innerHTML = data; // es veu extrany unes dècimes de segon
                 location.reload(); // mostrar resultados filtrados
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }
    </script>
    
</body>

	<br>
<!-- 	<label for="add">Afegir plat o beguda</label> -->
	<form action="./plat_to_insert.php">
    	<input id="add" type="submit" value="Afegir plat o beguda">
	</form>
	<br>
	<form action="../index.php">
		<input type="submit" value="Tornar a INDEX INICI">
	</form>

</html>
