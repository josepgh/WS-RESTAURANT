<?php 
session_start();
// $_SESSION['username'] = "chusep";
require '../includes/header.php';
require("../functions/funcions.php");
$conn = getConnexio();


if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $opcion = $_POST['opcion'] ?? '';
    
    $_SESSION['opcion_seleccionada'] = $opcion;
    
    echo "✅ Opción guardada en sesión: " . htmlspecialchars($opcion);
} else {
    echo "⚠️ Solicitud no válida.";
}




?>

<html>
<head>
<!-- <link -->
<!-- 	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" -->
<!-- 	rel="stylesheet" -->
<!-- 	integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" -->
<!-- 	crossorigin="anonymous"> -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- per al doble select -->

<!-- <link rel="stylesheet" -->
<!-- 	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"> -->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> -->

<!-- <script -->
<!-- 	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> -->

<!-- <link rel="stylesheet" type="text/css" href="../css/estils.css"> -->

<!-- Optional theme -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<title>Afegir plat</title>

</head>

<body>

	<table>
		<tr>
			<td colspan = "7">
				<h2>Gestio de plats i begudes</h2>
			</td>
		</tr>

		<tr>
			<td colspan = "7">

                <h3>Selecciona una categoria:</h3>
            	<p>
                <select id="categoria" onchange="guardarEnSessio(this)">
                    <option value="">-- Selecciona categoria --</option>
                    <?php
                    // Conexión a la BD
                    //$conn = new mysqli("localhost", "root", "mdb", "restaurantdb");
                    //$conn = getConnexio();
                    
                    
                    $sql = "SELECT id_categoria, nom FROM categories";
                    $result = $conn->query($sql);
                    while ($row = $result->fetch_assoc()) {
                        echo "<option value='".$row['id_categoria']."'>".$row['nom']."</option>";
                    }
                    mysqli_close($conn);
                    ?>
                </select>
                </p>
			</td>
		</tr>

<!-- 		<tr> -->
<!-- 			<td> -->

                <tbody id="files-plats">
                    <!-- Aquí se insertarán los productos -->
                </tbody>
        
        

<!-- 			</td> -->
<!-- 		</tr> -->


</table>

                <script>
                    $(document).ready(function(){
                        $('#categoria').on('change', function(){
                            var categoriaID = $(this).val();
                            if(categoriaID){
                                $.ajax({
                                    type: 'POST',
                                    url: 'plats_obtenir.php',
                                    data: {id_categoria: categoriaID},
                                    success: function(data){
                                        $('#files-plats').html(data);
                                    }
                                });
                            }else{
                                $('#files-plats').html('');
                            }
                        });
                    });
                </script>
    <script>
        let idSelect = null;
        let valorSeleccionado = null;

        function actualizarValor(select) {
            idSelect = select.id;
            valorSeleccionado = select.value;

            // Mostrar en el HTML
            document.getElementById("resultado").innerHTML = 
                "🆔 ID del select: <strong>" + idSelect + "</strong><br>" +
                "📦 Valor seleccionado: <strong>" + valorSeleccionado + "</strong>";
        }
    </script>
    
    <div id="resultado" style="margin-top: 20px; font-family: monospace; color: darkblue;"></div>


    <script>
        function guardarEnSessio(select) {
            const valor = select.value;

            //fetch('guardar_ajax.php', {
            fetch('plats_gestio.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'opcion=' + encodeURIComponent(valor)
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById("resultado").innerHTML = data;
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }
    </script>

</body>
<br><br>

	<form action="./plat_to_insert.php">
		<input type="submit" value="Afegir plat o beguda">
	</form>

	<br>
	<br>
	<form action="">
		<input type="submit" value="Tornar al llistat"> 
<!-- 		<input name="uname" value="" type="hidden"> -->
	</form>

	<form action="../index.php">
		<input type="submit" value="Tornar a l'inici">
	</form>


</html>